package io.trino.s2.geometry.functions;

import io.trino.sql.query.QueryAssertions;
import org.junit.jupiter.api.AfterAll;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.TestInstance;
import org.junit.jupiter.api.parallel.Execution;
import org.testcontainers.shaded.com.google.common.collect.ImmutableList;

import static org.assertj.core.api.Assertions.assertThat;
import static org.junit.jupiter.api.TestInstance.Lifecycle.PER_CLASS;
import static org.junit.jupiter.api.parallel.ExecutionMode.CONCURRENT;

@TestInstance(PER_CLASS)
@Execution(CONCURRENT)
public class TestS2Functions
{
    private QueryAssertions assertions;

    public TestS2Functions()
    {
        assertions = new QueryAssertions();
        assertions.addPlugin(new S2GeometryFunctionsPlugin());
    }

    @AfterAll
    public void teardown()
    {
        assertions.close();
    }

    @Test
    public void testS2Functions()
    {
        assertThat(assertions.expression(
                "s2_cell(32.15091, 34.848075)"))
                .isEqualTo("151d4816371ba05b");

        assertThat(assertions.expression(
                "s2_cell(32.15091, 34.848075, 15)"))
                .isEqualTo("151d48164");

        assertThat(assertions.expression(
                "s2_cell(-61.326853510565,0)"))
                .isEqualTo("b760000000000001");

        assertThat(assertions.expression(
                "s2_level(s2_cell(32.15091, 34.848075))"))
                .isEqualTo(30);

        assertThat(assertions.expression(
                "s2_level('f76')"))
                .isEqualTo(-1);

        assertThat(assertions.expression(
                "s2_distance('151d48164', 32.15000, 34.848000)"))
                .isEqualTo(168.9677806132969);

        assertThat(assertions.expression(
                "s2_childs('14e64ad5')"))
                .isEqualTo(ImmutableList.of("14e64ad44", "14e64ad4c", "14e64ad54", "14e64ad5c"));

        assertThat(assertions.expression(
                "s2_polygon_cover('POLYGON((79.353781784841460000000000000 21.230046625568562000000000000,79.353781020772290000000000000 21.230050485350244000000000000,79.350476393767820000000000000 21.232411200843462000000000000,79.346512273403100000000000000 21.233700093104580000000000000,79.345482325776330000000000000 21.234339905743090000000000000,79.345332800121070000000000000 21.234425918233110000000000000,79.345332800121070000000000000 21.234425918233107000000000000,79.345305096687370000000000000 21.234441854236270000000000000,79.345218280237650000000000000 21.234543697986535000000000000,79.345571448126920000000000000 21.234129399285870000000000000,79.345966626609370000000000000 21.233683216103213000000000000,79.346984082534620000000000000 21.233037569985580000000000000,79.346984082534630000000000000 21.233037569985576000000000000,79.346559654340280000000000000 21.233306899014080000000000000,79.350279187296660000000000000 21.232063012839653000000000000,79.350902850694780000000000000 21.231617137600860000000000000,79.353781784841460000000000000 21.230046625568562000000000000))',18)"))
                .isNull();

        assertThat(assertions.expression(
                "s2_polygon_cover('POLYGON((34.838904201049786 32.20971209756635,34.872249873168926 32.209530543414715,34.86379599999998 32.201796,34.85705829095457 32.17288947432473,34.85730482936083 32.17823824530681,34.85220840740965 32.17897379025877,34.85226182676695 32.17947323097507,34.841436206359845 32.19085065642912,34.838904201049786 32.20971209756635))',18)"))
                .isEqualTo(ImmutableList.of("151d387809", "151d38780b", "151d387875", "151d387877", "151d387879", "151d38787d", "151d38787f", "151d387884", "151d38789c", "151d3878a4", "151d3878ac", "151d3878b1", "151d3878b3", "151d3878bb", "151d3878bd", "151d387e25", "151d387e27", "151d387e2c", "151d387e31", "151d387e33", "151d387e35", "151d387f0b", "151d387f0d", "151d387f44", "151d387f49", "151d387f4d", "151d387f4f", "151d387f54", "151d387f5c", "151d387f7", "151d387f9", "151d387fa4", "151d387faf", "151d387fb4", "151d387fbc", "151d387fd", "151d387ff", "151d38804", "151d38809", "151d3880a3", "151d3880bc", "151d3880c4", "151d3880c9", "151d3880cd", "151d3880cf", "151d3880d4", "151d3880dc", "151d3880f", "151d38814", "151d38819", "151d3881b", "151d3881d", "151d3881e4", "151d3881ec", "151d3881f4", "151d3881f9", "151d3881fb", "151d3881fd", "151d388221", "151d388227", "151d388229", "151d38822b", "151d38822d", "151d3883c3", "151d3883c5", "151d3883d4", "151d3883dc", "151d3883e4", "151d3883e9", "151d3883ed", "151d3883ef", "151d3883f4", "151d3883fc", "151d38841", "151d38843", "151d388444", "151d38844c", "151d388451", "151d388453", "151d388469", "151d38846b", "151d38846d", "151d388473", "151d388475", "151d388575", "151d38859f", "151d3885a4", "151d3885a9", "151d3885ad", "151d3885af", "151d3885b4", "151d3885b9", "151d3885bb", "151d3885c9", "151d3885cb", "151d3885cd", "151d3885d3", "151d388683", "151d388691", "151d388695", "151d388697", "151d38869c", "151d3886b", "151d3886c1", "151d3886c5", "151d3886c7", "151d3886cc", "151d3886d4", "151d3886db", "151d38872b", "151d477629", "151d47762b", "151d4777c3", "151d4777d1", "151d4777d5", "151d4777d7", "151d4777dc", "151d4777e4", "151d4777e9", "151d4777ef", "151d4777f4", "151d4777fc", "151d47781", "151d477823", "151d47783d", "151d47783f", "151d477844", "151d477857", "151d47785c", "151d47787", "151d47789", "151d4778b", "151d4778d", "151d4778e4", "151d4778ec", "151d4778f4", "151d4778f9", "151d4778fb", "151d477927", "151d477929", "151d47792b", "151d477e03", "151d477e14", "151d477e1c", "151d477e3", "151d477e5", "151d477e67", "151d477e69", "151d477e6b", "151d477ec3", "151d477ed4", "151d477edc", "151d477ee4", "151d477ee9", "151d477eef", "151d477ef4", "151d477efc", "151d477f4", "151d477fc", "151d4784", "151d478804", "151d47880c", "151d478814", "151d478819", "151d47881b", "151d47881d", "151d478823", "151d478825", "151d47882d", "151d47882f", "151d478834", "151d47883c", "151d47885", "151d47887", "151d4788c", "151d47894", "151d47899", "151d4789b", "151d4789c4", "151d4789cc", "151d4789ec", "151d4789f3", "151d4789f5", "151d478a17", "151d478a19", "151d478a1f", "151d478a3", "151d478a5", "151d478ac3", "151d478ad4", "151d478adc", "151d478ae4", "151d478ae9", "151d478aef", "151d478af1", "151d478af7", "151d478afc", "151d478b4", "151d478bc", "151d478d", "151d478f", "151d4791", "151d4793", "151d47944", "151d4794c", "151d47951", "151d47953", "151d479544", "151d47954c", "151d47956c", "151d479574", "151d479579", "151d47957b", "151d479583", "151d479585", "151d47958d", "151d47958f", "151d479594", "151d47959c", "151d4795b", "151d4795d", "151d4795e4", "151d4795ec", "151d4795f1", "151d4795f3", "151d4795fc", "151d4797", "151d4799", "151d479b", "151d479c4", "151d479cc", "151d479d4", "151d479d9", "151d479db", "151d479dd", "151d479de4", "151d479dec", "151d479df1", "151d479df3", "151d479df5", "151d479dfb", "151d479dfd", "151d479e0c", "151d479e11", "151d479e13", "151d479e15", "151d479e39", "151d479e3f", "151d479e5", "151d479e7", "151d479ec", "151d479f4", "151d479f81", "151d479f83", "151d479f85", "151d479f9c", "151d479fa4", "151d479fac", "151d479fb1", "151d479fb3", "151d479fb5", "151d479fbb", "151d479fbd", "151d47a02b", "151d47a02d", "151d47a1b5", "151d47a1b7", "151d47a1b9", "151d47a1d", "151d47a1f", "151d47a204", "151d47a20c", "151d47a211", "151d47a213", "151d47a217", "151d47a21c", "151d47a263", "151d47a265", "151d47a26d", "151d47a26f", "151d47a274", "151d47a27c", "151d47a284", "151d47a289", "151d47a28f", "151d47a291", "151d47a29c", "151d47a2a4", "151d47a2ac", "151d47bd54", "151d47bd59", "151d47bd5b", "151d47bd5f", "151d47bd61", "151d47bd63", "151d47bd7d", "151d47bd7f", "151d47bd81", "151d47bd87", "151d47eab4", "151d47eab9", "151d47eabf", "151d47ead", "151d47eae4", "151d47eae9", "151d47eaeb", "151d47eaef", "151d47eafb", "151d47eafd", "151d47eb4", "151d47eb9", "151d47eba4", "151d47eba9", "151d47ebbd", "151d47ebf3", "151d47ebf5", "151d47ebf7", "151d47ec03", "151d47ec05", "151d47ec07", "151d47ec0c", "151d47ec14", "151d47ec1c", "151d47ec3", "151d47ec5", "151d47ec7", "151d47ecc", "151d47ed4", "151d47edc", "151d47ee1", "151d47ee3", "151d47ee44", "151d47ee49", "151d47ee4b", "151d47ee4f", "151d47ee5b", "151d47ee5d", "151d47ee5f", "151d47ee7", "151d47ee84", "151d47ee8c", "151d47ee91", "151d47ee9c", "151d47eea1", "151d47eef5", "151d47efcb", "151d47efcd", "151d47efd4", "151d47efd9", "151d47f00d", "151d47f00f", "151d47f014", "151d47f019", "151d47f03", "151d47f05", "151d47f064", "151d47f06c", "151d47f073", "151d47f08c", "151d47f093", "151d47f095", "151d47f0b7", "151d47f0b9", "151d47f0bf", "151d47f0d", "151d47f0f", "151d47f14", "151d47f1c", "151d47f3", "151d47f41", "151d47f424", "151d47f429", "151d47f42f", "151d47f431", "151d47f437", "151d47f43c", "151d47f45", "151d47f47", "151d47f4c", "151d47f503", "151d47f51d", "151d47f51f", "151d47f521", "151d47f527", "151d47f52c", "151d47f683", "151d47f694", "151d47f69c", "151d47f6b", "151d47f6d", "151d47f6e1", "151d47f6e7", "151d47f6ec", "151d47f717", "151d47f719", "151d47f71f", "151d47f73", "151d47f744", "151d47f749", "151d47f74f", "151d47f751", "151d47f755", "151d47f757", "151d47f75c", "151d47f95f", "151d47f961", "151d47f963", "151d47f965", "151d47f97c", "151d47f984", "151d47f98c", "151d47f991", "151d47f993", "151d47f9e1", "151d47f9e3", "151d47f9e5", "151d47f9ed", "151d47f9ef", "151d47f9f4", "151d47f9fc"));

        assertThat(assertions.expression(
                "s2_within('14e64ad5', array['151d387809', '151d387875'])"))
                .isEqualTo(false);

    }
}